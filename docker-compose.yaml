version: '3.8'

services:
  python-app:
    build: .
    container_name: python-app
    ports:
      - "5000:5000"  # Main app port
    privileged: true  # Required for accessing host devices
    devices:
      - /dev/ttyAMA0:/dev/ttyAMA0  # Allow access to USB devices (Bluetooth adapter)
      - /var/run/dbus:/var/run/dbus
    network_mode: "host"  # Allows direct communication with the host's Bluetooth stack
    volumes:
      - ./logs:/app/logs  # Mount local logs directory
    environment:
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/dbus/system_bus_socket
    restart: unless-stopped
    command: >
      sh -c "
      bluetoothd &
      python main.py &
      python3 -m http.server 8080 --directory logs &
      wait
      "
    depends_on:
      mqtt-broker:
        condition: service_healthy
        required: false  # Make mqtt-broker optional

  mqtt-broker:
    image: eclipse-mosquitto
    container_name: mqtt-broker
    ports:
      - "1883:1883"
    volumes:
    - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
    restart: on-failure  # Add restart policy
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 mosquitto_sub -p 1883 -t '$$SYS/#' -C 1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    deploy:
      replicas: 0  # Set to 0 to make it optional
